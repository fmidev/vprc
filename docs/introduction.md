# Introduction

The **vprc** package implements the Koistinen & Pohjola VPR (Vertical Profile of Reflectivity) correction algorithm. This method estimates and corrects for the range-dependent bias in radar rainfall estimates caused by the vertical variation of precipitation (e.g., the bright band, beam overshooting).

The algorithm processes Velocity Volume Processing (VVP) generated by the IRIS radar signal processor to produce a correction profile that can be applied to PPI or CAPPI products.

## The VPR Correction Pipeline

The processing chain consists of the following main stages:

### 1. Data Ingestion

The system reads IRIS VVP files (ASCII format), extracting the linear reflectivity profile (`lin_dbz`) and radar metadata. It handles various VVP formats and normalizes the height data to integer meters above the antenna.

### 2. Pre-processing

Before analysis, the raw profile undergoes cleaning:

* **Ground Clutter Removal**: Analyzes the gradient near the ground. If the reflectivity drops too sharply with height (indicating ground clutter), the lowest bins are invalidated.
* **Spike Smoothing**: Removes non-physical spikes (outliers) and fills small gaps to produce a continuous vertical profile.

### 3. Profile Classification

The algorithm classifies the vertical structure into one of several types to determine if it is suitable for correction:

* **Precipitation**: Continuous echo extending to the ground. This is the only type used for generating new corrections.
* **Altostratus**: Elevated precipitation layers that do not reach the ground (virga).
* **Clear Air Echo**: Low-level scattering from insects or turbulence.
* **Clutter**: Profiles dominated by residual clutter.

### 4. Bright Band Detection

For `Precipitation` profiles, the algorithm attempts to locate the **Bright Band**—the layer of enhanced reflectivity caused by melting snow.

* It analyzes the vertical gradient of reflectivity.
* It identifies the peak height, top, and bottom of the melting layer.
* The search is constrained by the freezing level height provided by numerical weather prediction (NWP) models.

### 5. Correction Calculation

If a profile is usable, the algorithm calculates correction factors:

1. **Interpolation**: The measured profile is interpolated to a high-resolution grid.
2. **Beam Simulation**: For every range bin (1–250 km), the algorithm simulates the radar beam's height and cross-section (using the 4/3 Earth radius model and Gaussian beam pattern).
3. **Convolution**: The interpolated profile is convolved with the simulated beam pattern to estimate what the radar *would* see at that range.
4. **Factor Derivation**: The correction (dB) is the difference between the estimated ground-level reflectivity and the simulated beam measurement.

**Climatological Fallback**: Weighted with an internal quality metric, the system can optionally blend in a climatological profile. This fallback profile represents typical precipitation structure for the region and season, ensuring that some correction is applied even when no accurate observation based VPR correction can be calculated.

### 6. Temporal Averaging

To prevent sudden jumps in the correction applied to operational products, instantaneous corrections are averaged over time.

* Newer profiles are given higher weight (linear decay).
* This results in a stable correction field that evolves smoothly with the weather system.

### 7. Multi-Radar Compositing

For radar networks, individual radar corrections can be combined into a seamless composite product:

* **Inverse Distance Weighting**: Corrections from multiple radars are blended using distance-based weights, giving priority to the nearest radar.
* **Cloud Optimized GeoTIFFs**: The composite corrections are exported as georeferenced raster files (COG format) for integration with operational radar products.
* **Quality Metadata**: The composite includes information about the number of contributing radars and weight distribution at each grid point.

This composite approach provides spatially continuous VPR corrections across the entire radar network domain.
